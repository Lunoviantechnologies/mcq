{% extends 'base.html' %}
{% load quiz_extras %}

{% block title %}{{ quiz.title }} - Quiz Application{% endblock %}

{% block extra_css %}
<style>
    .quiz-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
    }
    
    .quiz-header h2 {
        margin-bottom: 10px;
    }
    
    .question-card {
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 25px;
        background: #f9f9f9;
    }
    
    .question-number {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
        margin-bottom: 15px;
    }
    
    .question-text {
        font-size: 18px;
        color: #333;
        margin-bottom: 20px;
        font-weight: 500;
    }
    
    .choice-option {
        display: block;
        padding: 15px;
        margin-bottom: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        background: white;
    }
    
    .choice-option:hover {
        border-color: #667eea;
        background: #f0f4ff;
    }
    
    .choice-option input[type="radio"] {
        margin-right: 10px;
        cursor: pointer;
    }
    
    .choice-option.selected {
        border-color: #667eea;
        background: #e8edff;
    }
    
    .text-answer {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 5px;
        font-size: 16px;
        min-height: 100px;
    }
    
    .submit-section {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 20px;
        border-top: 2px solid #e0e0e0;
        margin-top: 30px;
        border-radius: 10px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }
    
    .progress-bar {
        height: 10px;
        background: #e0e0e0;
        border-radius: 5px;
        margin-bottom: 20px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.3s;
    }
</style>
{% endblock %}

{% block content %}
<div class="quiz-header">
    <h2>{{ quiz.title }}</h2>
    {% if quiz.description %}
    <p>{{ quiz.description }}</p>
    {% endif %}
</div>

<form id="quiz-form" method="post" action="{% url 'submit_quiz' quiz.id %}">
    {% csrf_token %}
    
    <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 10px;">
        <div style="font-weight: 600; color: #333;">Time remaining: <span id="quiz-timer" style="color: #dc3545;">--:--</span></div>
        <div class="progress-bar" style="flex: 1;">
            <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
        </div>
    </div>
    
    <div id="quiz-config" data-total-seconds="{{ total_time_seconds|default:0 }}" data-total-questions="{{ questions.count }}"></div>

    {% for question in questions %}
    <div class="question-card" data-question-id="{{ question.id }}">
        <div class="question-number">Question {{ forloop.counter }} of {{ questions.count }}</div>
        <div class="question-text">{{ question.question_text }}</div>
        
        {% if question.question_type == 'multiple_choice' %}
            {% for choice in question.choices.all %}
            <label class="choice-option {% if existing_answers|get_item:question.id and existing_answers|get_item:question.id.selected_choice.id == choice.id %}selected{% endif %}">
                <input type="radio" 
                       name="question_{{ question.id }}" 
                       value="{{ choice.id }}"
                       data-question-id="{{ question.id }}"
                       data-choice-id="{{ choice.id }}"
                       {% if existing_answers|get_item:question.id and existing_answers|get_item:question.id.selected_choice.id == choice.id %}checked{% endif %}>
                {{ choice.choice_text }}
            </label>
            {% endfor %}
        {% else %}
            <textarea class="text-answer" 
                      name="question_{{ question.id }}"
                      data-question-id="{{ question.id }}"
                      placeholder="Type your answer here...">{% if existing_answers|get_item:question.id %}{{ existing_answers|get_item:question.id.answer_text }}{% endif %}</textarea>
        {% endif %}
    </div>
    {% endfor %}
    
    <div class="submit-section">
        <button type="submit" class="btn btn-success" style="width: 100%; font-size: 18px; padding: 15px;">
            Submit Quiz
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    // -------- Anti-cheating: immediate submit on window/tab switch --------
    function handleFocusViolation() {
        // Prevent repeated submits
        if (window.__autoSubmitQuiz) {
            return;
        }
        alert('You switched away from the quiz window/tab. The quiz will now be submitted.');
        window.__autoSubmitQuiz = true;
        const form = document.getElementById('quiz-form');
        if (form) {
            form.submit();
        }
    }

    // Detect when user switches away from the quiz tab/window
    document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
            handleFocusViolation();
        }
    });

    // Detect when window loses focus (e.g., Alt+Tab, switching apps)
    window.addEventListener('blur', function () {
        handleFocusViolation();
    });

    // -------- Config from DOM (to avoid template vars in JS lint) --------
    const configEl = document.getElementById('quiz-config');
    const totalTimeSeconds = parseInt((configEl && configEl.dataset.totalSeconds) || '0', 10);
    const totalQuestions = parseInt((configEl && configEl.dataset.totalQuestions) || '0', 10);

    // -------- Timer (total from per-question limits) --------
    let remainingSeconds = totalTimeSeconds;
    const timerEl = document.getElementById('quiz-timer');

    function formatTime(s) {
        const m = Math.floor(s / 60);
        const sec = s % 60;
        return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
    }

    function tickTimer() {
        if (remainingSeconds <= 0) {
            if (!window.__autoSubmitQuiz) {
                window.__autoSubmitQuiz = true;
                alert('Time is up. The quiz will be submitted automatically.');
                const form = document.getElementById('quiz-form');
                if (form) form.submit();
            }
            return;
        }
        remainingSeconds -= 1;
        if (timerEl) {
            timerEl.textContent = formatTime(remainingSeconds);
        }
    }

    if (totalTimeSeconds > 0) {
        // Initialize display immediately
        if (timerEl) timerEl.textContent = formatTime(remainingSeconds);
        setInterval(tickTimer, 1000);
    }

    // Auto-save answers
    document.querySelectorAll('input[type="radio"], textarea.text-answer').forEach(function(element) {
        element.addEventListener('change', function() {
            const questionId = this.dataset.questionId || this.getAttribute('name').replace('question_', '');
            const formData = new FormData();
            formData.append('question_id', questionId);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            if (this.type === 'radio') {
                formData.append('choice_id', this.value);
                // Update visual selection
                document.querySelectorAll(`input[name="question_${questionId}"]`).forEach(function(radio) {
                    radio.closest('.choice-option').classList.remove('selected');
                });
                this.closest('.choice-option').classList.add('selected');
            } else {
                formData.append('answer_text', this.value);
            }
            
            fetch('{% url "submit_answer" quiz.id %}', {
                method: 'POST',
                body: formData
            }).then(response => response.json()).then(data => {
                if (data.success) {
                    updateProgress();
                }
            });
        });
    });
    
    // Update progress bar
    function updateProgress() {
        let answered = 0;
        
        document.querySelectorAll('.question-card').forEach(function(card) {
            const questionId = card.dataset.questionId;
            const hasRadioAnswer = card.querySelector(`input[name="question_${questionId}"]:checked`);
            const textEl = card.querySelector(`textarea[name="question_${questionId}"]`);
            const hasTextAnswer = textEl && textEl.value.trim();
            
            if (hasRadioAnswer || hasTextAnswer) {
                answered++;
            }
        });
        
        const progress = (answered / totalQuestions) * 100;
        document.getElementById('progress-fill').style.width = progress + '%';
    }
    
    // Initial progress update
    updateProgress();
    
    // Confirm submission (skip confirm when auto-submitting due to cheating)
    document.getElementById('quiz-form').addEventListener('submit', function(e) {
        if (window.__autoSubmitQuiz) {
            return;  // no confirm on forced submit
        }
        if (!confirm('Are you sure you want to submit the quiz? You cannot change your answers after submission.')) {
            e.preventDefault();
        }
    });
</script>
{% endblock %}


{% extends 'base.html' %}
{% load quiz_extras %}

{% block title %}{{ quiz.title }} - Quiz Application{% endblock %}

{% block extra_css %}
<style>
    .quiz-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        padding: 2rem;
        border-radius: 16px;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-lg);
    }
    
    .quiz-header h2 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        color: white;
    }
    
    .quiz-header p {
        opacity: 0.95;
        font-size: 1.1rem;
    }
    
    .quiz-info-bar {
        background: var(--white);
        padding: 1.25rem 1.5rem;
        border-radius: 12px;
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1.5rem;
        flex-wrap: wrap;
    }
    
    .timer-section {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
    }
    
    .timer-label {
        font-weight: 600;
        color: var(--gray);
        font-size: 0.95rem;
    }
    
    .timer-display {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--danger-color);
        font-variant-numeric: tabular-nums;
    }
    
    .progress-container {
        flex: 1;
        min-width: 200px;
    }
    
    .progress-bar {
        height: 12px;
        background: var(--gray-lighter);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
    }
    
    .question-card {
        background: var(--white);
        border: 2px solid var(--gray-lighter);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-sm);
        transition: all 0.3s;
    }
    
    .question-card:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--primary-light);
    }
    
    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .question-number {
        display: inline-flex;
        align-items: center;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 0.5rem 1.25rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.9rem;
        box-shadow: var(--shadow-sm);
    }
    
    .question-text {
        font-size: 1.25rem;
        color: var(--dark);
        margin-bottom: 1.5rem;
        font-weight: 500;
        line-height: 1.6;
    }
    
    .choices-container {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .choice-option {
        display: flex;
        align-items: center;
        padding: 1rem 1.25rem;
        border: 2px solid var(--gray-lighter);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--white);
        position: relative;
    }
    
    .choice-option:hover {
        border-color: var(--primary-light);
        background: #f5f7ff;
        transform: translateX(4px);
    }
    
    .choice-option input[type="radio"] {
        width: 20px;
        height: 20px;
        margin-right: 1rem;
        cursor: pointer;
        accent-color: var(--primary-color);
    }
    
    .choice-option.selected {
        border-color: var(--primary-color);
        background: linear-gradient(90deg, rgba(79, 70, 229, 0.1), rgba(139, 92, 246, 0.1));
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    .choice-option.selected::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: var(--primary-color);
        border-radius: 12px 0 0 12px;
    }
    
    .choice-text {
        flex: 1;
        font-size: 1rem;
        color: var(--dark);
    }
    
    .text-answer {
        width: 100%;
        padding: 1rem 1.25rem;
        border: 2px solid var(--gray-lighter);
        border-radius: 12px;
        font-size: 1rem;
        min-height: 150px;
        font-family: inherit;
        resize: vertical;
        transition: all 0.2s;
    }
    
    .text-answer:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    .submit-section {
        position: sticky;
        bottom: 20px;
        background: var(--white);
        padding: 1.5rem 2rem;
        border-radius: 16px;
        box-shadow: var(--shadow-xl);
        margin-top: 2rem;
        border: 2px solid var(--gray-lighter);
    }
    
    .submit-btn {
        width: 100%;
        padding: 1rem 2rem;
        background: linear-gradient(135deg, var(--success-color), #059669);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: var(--shadow-md);
        font-family: inherit;
    }
    
    .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        background: linear-gradient(135deg, #059669, #047857);
    }
    
    .submit-btn:active {
        transform: translateY(0);
    }
    
    @media (max-width: 768px) {
        .quiz-info-bar {
            flex-direction: column;
            align-items: stretch;
        }
        
        .timer-section {
            justify-content: space-between;
        }
        
        .question-card {
            padding: 1.5rem;
        }
        
        .question-text {
            font-size: 1.1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="quiz-header">
    <h2>{{ quiz.title }}</h2>
    {% if quiz.description %}
    <p>{{ quiz.description }}</p>
    {% endif %}
</div>

<form id="quiz-form" method="post" action="{% url 'submit_quiz' quiz.id %}">
    {% csrf_token %}
    
    <div class="quiz-info-bar">
        <div class="timer-section">
            <span class="timer-label">Time Remaining:</span>
            <span class="timer-display" id="quiz-timer">--:--</span>
        </div>
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
            </div>
        </div>
    </div>
    
    <div id="quiz-config" data-total-seconds="{{ total_time_seconds|default:0 }}" data-total-questions="{{ questions.count }}" style="display: none;"></div>

    {% for question in questions %}
    <div class="question-card" data-question-id="{{ question.id }}">
        <div class="question-header">
            <div class="question-number">Question {{ forloop.counter }} of {{ questions.count }}</div>
        </div>
        <div class="question-text">{{ question.question_text }}</div>
        
        {% if question.question_type == 'multiple_choice' %}
            <div class="choices-container">
                {% for choice in question.choices.all %}
                <label class="choice-option {% if existing_answers|get_item:question.id and existing_answers|get_item:question.id.selected_choice.id == choice.id %}selected{% endif %}">
                    <input type="radio" 
                           name="question_{{ question.id }}" 
                           value="{{ choice.id }}"
                           data-question-id="{{ question.id }}"
                           data-choice-id="{{ choice.id }}"
                           {% if existing_answers|get_item:question.id and existing_answers|get_item:question.id.selected_choice.id == choice.id %}checked{% endif %}>
                    <span class="choice-text">{{ choice.choice_text }}</span>
                </label>
                {% endfor %}
            </div>
        {% else %}
            <textarea class="text-answer" 
                      name="question_{{ question.id }}"
                      data-question-id="{{ question.id }}"
                      placeholder="Type your detailed answer here...">{% if existing_answers|get_item:question.id %}{{ existing_answers|get_item:question.id.answer_text }}{% endif %}</textarea>
        {% endif %}
    </div>
    {% endfor %}
    
    <div class="submit-section">
        <button type="submit" class="submit-btn">
            âœ“ Submit Quiz
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    // Anti-cheating: immediate submit on window/tab switch
    function handleFocusViolation() {
        if (window.__autoSubmitQuiz) {
            return;
        }
        alert('You switched away from the quiz window/tab. The quiz will now be submitted.');
        window.__autoSubmitQuiz = true;
        const form = document.getElementById('quiz-form');
        if (form) {
            form.submit();
        }
    }

    document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
            handleFocusViolation();
        }
    });

    window.addEventListener('blur', function () {
        handleFocusViolation();
    });

    // Timer configuration
    const configEl = document.getElementById('quiz-config');
    const totalTimeSeconds = parseInt((configEl && configEl.dataset.totalSeconds) || '0', 10);
    const totalQuestions = parseInt((configEl && configEl.dataset.totalQuestions) || '0', 10);

    // Timer functionality
    let remainingSeconds = totalTimeSeconds;
    const timerEl = document.getElementById('quiz-timer');

    function formatTime(s) {
        const m = Math.floor(s / 60);
        const sec = s % 60;
        return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
    }

    function tickTimer() {
        if (remainingSeconds <= 0) {
            if (!window.__autoSubmitQuiz) {
                window.__autoSubmitQuiz = true;
                alert('Time is up. The quiz will be submitted automatically.');
                const form = document.getElementById('quiz-form');
                if (form) form.submit();
            }
            return;
        }
        remainingSeconds -= 1;
        if (timerEl) {
            timerEl.textContent = formatTime(remainingSeconds);
            // Change color when time is low
            if (remainingSeconds < 60) {
                timerEl.style.color = '#dc2626';
                timerEl.style.animation = 'pulse 1s infinite';
            }
        }
    }

    if (totalTimeSeconds > 0) {
        if (timerEl) timerEl.textContent = formatTime(remainingSeconds);
        setInterval(tickTimer, 1000);
    }

    // Auto-save answers
    document.querySelectorAll('input[type="radio"], textarea.text-answer').forEach(function(element) {
        element.addEventListener('change', function() {
            const questionId = this.dataset.questionId || this.getAttribute('name').replace('question_', '');
            const formData = new FormData();
            formData.append('question_id', questionId);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            if (this.type === 'radio') {
                formData.append('choice_id', this.value);
                // Update visual selection
                document.querySelectorAll(`input[name="question_${questionId}"]`).forEach(function(radio) {
                    radio.closest('.choice-option').classList.remove('selected');
                });
                this.closest('.choice-option').classList.add('selected');
            } else {
                formData.append('answer_text', this.value);
            }
            
            fetch('{% url "submit_answer" quiz.id %}', {
                method: 'POST',
                body: formData
            }).then(response => response.json()).then(data => {
                if (data.success) {
                    updateProgress();
                }
            });
        });
    });
    
    // Update progress bar
    function updateProgress() {
        let answered = 0;
        
        document.querySelectorAll('.question-card').forEach(function(card) {
            const questionId = card.dataset.questionId;
            const hasRadioAnswer = card.querySelector(`input[name="question_${questionId}"]:checked`);
            const textEl = card.querySelector(`textarea[name="question_${questionId}"]`);
            const hasTextAnswer = textEl && textEl.value.trim();
            
            if (hasRadioAnswer || hasTextAnswer) {
                answered++;
            }
        });
        
        const progress = (answered / totalQuestions) * 100;
        const progressFill = document.getElementById('progress-fill');
        if (progressFill) {
            progressFill.style.width = progress + '%';
        }
    }
    
    // Initial progress update
    updateProgress();
    
    // Confirm submission
    document.getElementById('quiz-form').addEventListener('submit', function(e) {
        if (window.__autoSubmitQuiz) {
            return;
        }
        if (!confirm('Are you sure you want to submit the quiz? You cannot change your answers after submission.')) {
            e.preventDefault();
        }
    });

    // Add pulse animation for low time
    const style = document.createElement('style');
    style.textContent = `
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}
